<!DOCTYPE html>
<html>
<head>
	<title>PSP Control</title>
	<style>
		body {
	   font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
  	}
		#display {
			border-radius: 15px;
			background: #ECFFDC;
			margin: 20px;
			padding: 0;
			padding-left: 10px;
			width: 400px;
			height: 250px;
		}
		#limits {
			width: 100%;
			height: 100%;
			padding: 0;
		}
		.mainValue {
			font-size: 48px;
			padding: 0;
			vertical-align: sub;
		}
		.unit {
			font-size: 24px;
			padding: 0;
			vertical-align: sub;
		}
		.limitUnit {
			font-size: 14px;
		}
		#display td:nth-child(1) {
			width: 25%;
		}
		#display td:nth-child(2) {
			width: 25%;
		}
		#display td:nth-child(3) {
			width: 25%;
		}
		#display td:nth-child(4) {
			width: 25%;
		}
		#limits td:nth-child(1) {
			width: 50%;
			font-size: 16px;
			text-align: right;
			padding-right: 10px;
		}
		#limits td:nth-child(2) {
			width: 50%;
			padding: 0;
		}
		.limit {
			font-size: 30px;
		}
		#remote {
			font-size: 16px;
			text-align: center;
		}
		#tempOutput {
			text-align: center;
		}
		.active {
			font-weight: bold;
			color: black;
		}
		.inactive {
			font-weight: normal;
			color: lightgray;
		}
		.blurred {
			filter: blur(3px) grayscale(100%);
  		opacity: 0.6
		}
		#voltageInput {
			width: 50px;
		}
	</style>
</head>
<body>
	<p>
		<button onclick="connect()" class="disconnected">Connect</button>
		<button onclick="disconnect()" class="connected">Disconnect</button>
		<button onclick="writeSerial(new Uint8Array([0x01, 0x06, 0x00, 0x09, 0x00, 0x01]))" class="connected">On</button>
		<button onclick="writeSerial(new Uint8Array([0x01, 0x06, 0x00, 0x09, 0x00, 0x00]))" class="connected">Off</button>
	</p>
	<form onsubmit="setVoltage(document.getElementById('voltageInput').value); return false;">
		<input type="text" name="voltage" id="voltageInput" value="12.00" class="connected">V
		<input type="submit" value="Set" class="connected">
	</form>
	<table id="display" class="blurred">
		<colgroup>
			<col>
			<col>
			<col>
			<col>
		</colgroup>
		<tr>
			<td colspan="2">
				<span class="mainValue" id="voltage">00.00</span>
				<span class="unit">V</span>
			</td>
			<td rowspan="2" colspan="2">
				<table id="limits">
					<tr>
						<td>V-const</td>
						<td><span class="limit" id="vLimit">00</span> <span class="limitUnit">V</span></td>
					</tr>
					<tr>
						<td>I-const</td>
						<td><span class="limit" id="iLimit">0.00</span> <span class="limitUnit">A</span></td>
					</tr>
					<tr>
						<td>P-const</td>
						<td><span class="limit" id="pLimit">000</span> <span class="limitUnit">W</span></td>
					</tr>
				</table>
			</td>
		</tr>
		<tr>
			<td colspan="2">
				<span class="mainValue" id="current">0.000</span>
				<span class="unit">A</span>
			</td>
		</tr>
		<tr>
			<td colspan="2">
				<span class="mainValue" id="power">000.0</span>
				<span class="unit">W</span>
			</td>
			<td></td>
			<td rowspan="2" id="tempOutput">
				<div id="overtemp">Overtemp</div>
				<div>Output</div>
				<div><span id="outputOn">On</span> <span id="outputOff">Off</span></div>
			</td>
		</tr>
		<tr>
			<td id="remote">remote</td>
			<td id="locked">locked</td>
			<td>&nbsp;</td>
		</tr>
	</table>
	<script type="text/javascript">
		if (window.isSecureContext) {
			console.log("Secure!");
		} else {
			console.log("No secure context. Everything else will fail");
		}

		const statusMsg = new Uint8Array([0x01, 0x03, 0x00, 0x00, 0x00, 0x0D]);
		let port;
		let status;
		let refreshInterval;

		navigator.serial.addEventListener('connect', event => {
			console.log("Connect event", event);
		});

		function connect() {
			navigator.serial.requestPort({ filters: []}).then((new_port) => {
					port = new_port;
					console.log(port);
					port.open({baudRate: 9600}).then(() => {
						document.querySelectorAll('.connected').forEach(element => {
							element.disabled = false;
						});
						document.querySelectorAll('.disconnected').forEach(element => {
							element.disabled = true;
						});
						// Delay first query a bit, but don't wait the full 5 seconds
						setTimeout(() => {writeSerial(statusMsg);}, 1000);
						// Reload data every 5 seconds
						refreshInterval = setInterval(() => {writeSerial(statusMsg);}, 5000);
						console.log("Connected");
				}).catch((e) => {
					alert('Could not connect: ' + e);
				});
			});
		}
		
		function crc16(buffer) {
			var crc = 0xFFFF;
			var odd;

			for (var i = 0; i < buffer.length; i++) {
				crc = crc ^ buffer[i]; // XOR byte into least sig. byte of crc

				for (var j = 0; j < 8; j++) { // Loop over each bit
					odd = crc & 0x0001;
					crc = crc >> 1; // Shift right
					if (odd) {
						crc = crc ^ 0xA001; // If LSB is set XOR 0xA001
					}
				}
			}

			return crc;
		}
		
		function hexString(data) {
			return Array.from(data).map((i) => i.toString(16).padStart(2, '0')).join('');
		}
		
		function toInt16(h, l) {
			return (h << 8) | l;
		}

		function disconnect() {
			document.getElementById('display').classList.add('blurred');
			if(port) {
				if(refreshInterval) {
					clearInterval(refreshInterval);
				}
				port.close().then(() => {
					console.log("Disconnected");
					document.querySelectorAll('.connected').forEach(element => {
						element.disabled = true;
					});
					document.querySelectorAll('.disconnected').forEach(element => {
						element.disabled = false;
					});
					port = null;
				});
			}
		}

		async function writeSerial(data) {
			const crc = crc16(data);
			const msg = new Uint8Array(data.length + 2);
			msg.set(data);
			msg.set([(crc & 0xFF), (crc >> 8)], data.length);
			const writer = port.writable.getWriter();
			await writer.write(msg);
			writer.releaseLock();
			console.log("Sent " + hexString(msg));
			readSerial();
		}

		async function readSerial() {
			if(port.readable) {
				try {
					const reader = port.readable.getReader();
					let header = new Uint8Array(3); // deviceId, function code, response length
					let hBytes = 3;
					let msg = undefined;
					let mBytes = 0;
					try {
						while(hBytes > 0) {
							const { value, done } = await reader.read();
							if (done) {
								console.log("reader closed ...");
								return;
							}
							if(value.length < hBytes) {
								header.set(value, 3-hBytes);
								hBytes -= value.length;
							} else {
								header.set(value.slice(0, hBytes), 3-hBytes);
								if(header[1] == 0x03) {
									mBytes = header[2] + 2;
								} else if(header[1] == 0x06) {
									mBytes = 6;
									hBytes--; // No length field
								} else {
									console.log('Unsupported function code: '  + header[1].toString(16));
								}
								msg = new Uint8Array(mBytes);
								//console.log(hexString(value), hBytes, mBytes);
								msg.set(value.slice(hBytes, hBytes+mBytes));
								mBytes -= value.length-hBytes;
								break;
							}
						}
						
						console.log("Response length: " + header[2]);
						
						while(mBytes > 0) {
							const { value, done } = await reader.read();
							if (done) {
								console.log("reader closed ...");
								return;
							}
							msg.set(value, header[2] - mBytes);
							mBytes -= value.length;
						}
						
						if(header[0] != 0x01) {
							console.log("Ignoring message for deviceId: " + header[0].toString(16));
						}
						
						if(header[1] == 0x03) {
							let fullMsg = new Uint8Array(msg.length + 1);
							fullMsg.set(header);
							fullMsg.set(msg.slice(0, msg.length-2), 3);
							const crc = crc16(fullMsg);
							if((crc & 0xFF) != msg[msg.length-2] || (crc >> 8) != msg[msg.length-1]) {
								console.log('CRC mismatch! Expected: ' + (crc & 0xFF).toString(16) + (crc >> 8).toString(16) + ' Got: ' + msg[msg.length-2].toString(16) + msg[msg.length-1].toString(16));
								return;
							}
							parseResponse(msg);
						} else if(header[1] == 0x06) {
							writeSerial(statusMsg);
						}
					} catch (error) {
						console.log(error);
					} finally {
						reader.releaseLock();
					}
				} catch (error) {
					console.log(error);
				}
			} else {
				console.log("not readable");
			}
		}

		function parseResponse(response) {
			console.log(hexString(response), response.length);
			if(response.length == 28) {
				status = {
            voltage: toInt16(response[4], response[5]) / 100.0,
            current: toInt16(response[6], response[7]) / 1000.0,
            power: toInt16(response[8], response[9]) / 100.0,
            voltage_limit: toInt16(response[0], response[1]) / 100.0,
            current_limit: toInt16(response[2], response[3]) / 1000.0,
            power_limit: 0,
            output: toInt16(response[18], response[19]),
            overtemp: 0,
            fine_control: 0,
            wheel_locked: 0,
            remote: 0,
            locked: toInt16(response[12], response[13])
				}
				document.getElementById('voltage').innerText = status.voltage;
				document.getElementById('current').innerText = status.current;
				document.getElementById('power').innerText = status.power;
				document.getElementById('vLimit').innerText = status.voltage_limit;
				document.getElementById('iLimit').innerText = status.current_limit;
				document.getElementById('pLimit').innerText = status.power_limit;
				document.getElementById('remote').classList.add(status.remote ? 'active' : 'inactive');
				document.getElementById('remote').classList.remove(status.remote ? 'inactive' : 'active');
				document.getElementById('locked').classList.add(status.locked ? 'active' : 'inactive');
				document.getElementById('locked').classList.remove(status.locked ? 'inactive' : 'active');
				document.getElementById('overtemp').classList.add(status.overtemp ? 'active' : 'inactive');
				document.getElementById('overtemp').classList.remove(status.overtemp ? 'inactive' : 'active');
				document.getElementById('outputOn').classList.add(status.output ? 'active' : 'inactive');
				document.getElementById('outputOn').classList.remove(status.output ? 'inactive' : 'active');
				document.getElementById('outputOff').classList.add(status.output ? 'inactive' : 'active');
				document.getElementById('outputOff').classList.remove(status.output ? 'active' : 'inactive');
				document.getElementById('display').classList.remove('blurred');
				console.log(status);
				return;
			} else {
				alert('Unknown response: ' + response.length);
			}
		}

		function setVoltage(voltage) {
			const voltageRegExp = /^[0-9]{2}\.[0-9]{2}$/;
			console.log(voltage);
			if(!voltageRegExp.test(voltage)) {
				alert('Voltage has to be in format xx.xx!');
				return;
			}
			
			writeSerial(new Uint8Array([0x01, 0x06, 0x00, 0x00, voltage*100 >> 8, voltage*100 & 0XFF]));
		}
		document.querySelectorAll('.connected').forEach(element => {
			element.disabled = true;
		});
	</script>
</body>
</html>